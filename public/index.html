<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 70%; }
        #chart_div { height: 30%; }
    </style>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyDl9TGC98BJn4hMIHL5o7umITbXqF2YbzQ"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>
        // JavaScript Document
                  // TODO: Code cleaning up.
                  // TODO: Mapa que sea optativo para mostrar
                  // TODO: Recomendacion online segun altura del tipo de carrera: rapido, loma, constante, ...
                  // TODO: Que se pueda definir nuevas rutas tomando puntos seleccionados por el usuario. luego se genera la ruta.
                  // TODO: Opcion para guardar y cargar mapas
                  var map = null;
                  var chart = null;
                  var ida = true;

                  var geocoderService = null;
                  var elevationService = null;
                  var directionsService = null;

                  var mousemarker = null;
                  var markers = [];
                  var polyline = null;
                  var elevations = null;

                  // TODO: Configurable. Asi se puede hacer para cualquier lado
                  var SAMPLES = 256;

                  var examples = [{
                    // 10 k
                    latlngs: [
                [-38.005022,-57.542555], // partida
                [-38.008608,-57.533320], // torreon
                [-38.017616,-57.525421], // cabo corrientes
                //[-38.0264774,-57.5319665], //celso aldao
                [-38.030257, -57.533665], // paseo victoria ocampo
                //[-38.027740,-57.532767], // tunel playa grande
                [-38.016550,-57.524441], // paseo galindez 1
                [-38.007977, -57.537303], // paseo galindez 2
                //[-38.005413,-57.542419] // plaza colon
                [-38.006747, -57.539058], // los lobos
                [-37.998802, -57.541765], // rotanda de los pescadores 1
                [-37.999154, -57.542185], // rotanda de los pescadores 2
                [-38.005022,-57.542555] // partida
                    ],
                    mapType: google.maps.MapTypeId.ROADMAP, // ROADMAP TERRAIN SATELLITE
                    travelMode: 'walking'//'walking''direct' 'driving'
                  },{
                    // 21 k
                    latlngs: [
                [-38.005022,-57.542555], // partida
                [-38.008608,-57.533320], // torreon
                [-38.017616,-57.525421], // cabo corrientes
                [-38.040665, -57.542219], //jb justo y peralta ramos
                [-38.035723,-57.524916], // terminal crucero
                //[-38.027740,-57.532767], // tunel playa grande
                [-38.016550,-57.524441], // paseo galindez 1
                [-38.007977, -57.537303], // paseo galindez 2
                [-37.970714, -57.542560], // constitución
                //[-37.987491, -57.545662], // ituzaingo e independencia
                [-37.995142, -57.543851], // 11 de eseptiembre y la costa
                [-38.005022,-57.542555] // partida
                    ],
                    mapType: google.maps.MapTypeId.ROADMAP,
                    travelMode: 'walking'
                  },{
                    // 42 k
                    latlngs: [
                [-38.005022,-57.542555], // partida
                [-38.008608,-57.533320], // torreon
                [-38.017616,-57.525421], // cabo corrientes
                [-38.040665, -57.542219], //jb justo y peralta ramos
                [-38.035723,-57.524916], // terminal crucero
                //[-38.027740,-57.532767], // tunel playa grande
                [-38.016550,-57.524441], // paseo galindez 1
                [-38.007977, -57.537303], // paseo galindez 2
                [-37.970714, -57.542560], // constitución
                //[-37.987491, -57.545662], // ituzaingo e independencia
                [-37.995142, -57.543851], // 11 de eseptiembre y la costa
                [-38.005022,-57.542555] // partida
                    ],
                    mapType: google.maps.MapTypeId.ROADMAP,
                    travelMode: 'walking'
                  }];

                  // Load the Visualization API and the piechart package.
                  google.load("visualization", "1", {packages: ["corechart"]});

                  // Set a callback to run when the Google Visualization API is loaded.
                  google.setOnLoadCallback(initialize);

                  var marker;
                  var route = [];

                  function placeMarker(location) {
                      marker = new google.maps.Marker({
                          position: location,
                          map: map
                        });
                      route.push(marker);
                  }

                  function initialize() {
                    var myLatlng = new google.maps.LatLng(-38.005022,-57.542555);
                    var myOptions = {
                      zoom: 16,
                      center: myLatlng,
                      mapTypeId: google.maps.MapTypeId.TERRAIN
                    }
                    infowindow = new google.maps.InfoWindow();
                    map = new google.maps.Map(document.getElementById("map"), myOptions);
                    chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));

                    var centerControlDiv = document.createElement('div');
                    var centerControl = new BackButton(centerControlDiv, map);
                    var backButton = new RouteButton(centerControlDiv, map);
                    //var hideButton = new HideMapButton(centerControlDiv, map);

                    centerControlDiv.index = 1;
                    map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);

                    geocoderService = new google.maps.Geocoder();
                    elevationService = new google.maps.ElevationService();
                    directionsService = new google.maps.DirectionsService();
                    google.maps.event.addListener(map, 'click', function(event) {
                      placeMarker(event.latLng);
                    });

                  }

                  function failureGetPosition() {
                    handleLocationError(true, infoWindow, map.getCenter());
                  }

                  function updatePosition(position) {
                          //reset();
                          clearMarkers();
                          cleanupRoutes();
                          var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                          };
                           map.setCenter(pos);
                           var latLong = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                           marker = new google.maps.Marker({position:latLong, map: map, icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"});
                           markers.push(marker);
                           find_closest_marker(pos);
                  }

                  function BackButton(controlDiv, map) {

                      // Set CSS for the control border.
                      var controlUI = document.createElement('div');
                      controlUI.style.backgroundColor = '#fff';
                      controlUI.style.border = '2px solid #fff';
                      controlUI.style.borderRadius = '3px';
                      controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                      controlUI.style.cursor = 'pointer';
                      controlUI.style.marginBottom = '22px';
                      controlUI.style.textAlign = 'center';
                      controlUI.title = 'Ida';
                      controlDiv.appendChild(controlUI);

                      // Set CSS for the control interior.
                      var controlText = document.createElement('div');
                      controlText.style.color = 'rgb(25,25,25)';
                      controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                      controlText.style.fontSize = '16px';
                      controlText.style.lineHeight = '38px';
                      controlText.style.paddingLeft = '5px';
                      controlText.style.paddingRight = '5px';
                      controlText.innerHTML = 'Ida';
                      controlUI.appendChild(controlText);

                      // Setup the click event listeners: simply set the map to Chicago.
                      controlUI.addEventListener('click', function() {
                          if (ida) {
                            controlText.innerHTML = 'Vuelta';
                          } else {
                            controlText.innerHTML = 'Ida';
                          }
                          ida = (!ida);
                      });

                    }

                  function HideMapButton(controlDiv, map) {

                      // Set CSS for the control border.
                      var controlUI = document.createElement('div');
                      controlUI.style.backgroundColor = '#fff';
                      controlUI.style.border = '2px solid #fff';
                      controlUI.style.borderRadius = '3px';
                      controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                      controlUI.style.cursor = 'pointer';
                      controlUI.style.marginBottom = '22px';
                      controlUI.style.textAlign = 'center';
                      controlUI.title = 'Hide Map';
                      controlDiv.appendChild(controlUI);

                      // Set CSS for the control interior.
                      var controlText = document.createElement('div');
                      controlText.style.color = 'rgb(25,25,25)';
                      controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                      controlText.style.fontSize = '16px';
                      controlText.style.lineHeight = '38px';
                      controlText.style.paddingLeft = '5px';
                      controlText.style.paddingRight = '5px';
                      controlText.innerHTML = 'Hide Map';
                      controlUI.appendChild(controlText);

                      // Setup the click event listeners: simply set the map to Chicago.
                      controlUI.addEventListener('click', function() {
                          $(map).hide();
                      });

                    }

                  function RouteButton(controlDiv, map) {

                      // Set CSS for the control border.
                      var controlUI = document.createElement('div');
                      controlUI.style.backgroundColor = '#fff';
                      controlUI.style.border = '2px solid #fff';
                      controlUI.style.borderRadius = '3px';
                      controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                      controlUI.style.cursor = 'pointer';
                      controlUI.style.marginBottom = '22px';
                      controlUI.style.textAlign = 'center';
                      controlUI.title = 'Route';
                      controlDiv.appendChild(controlUI);

                      // Set CSS for the control interior.
                      var controlText = document.createElement('div');
                      controlText.style.color = 'rgb(25,25,25)';
                      controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                      controlText.style.fontSize = '16px';
                      controlText.style.lineHeight = '38px';
                      controlText.style.paddingLeft = '5px';
                      controlText.style.paddingRight = '5px';
                      controlText.innerHTML = 'Route';
                      controlUI.appendChild(controlText);

                      // Setup the click event listeners: simply set the map to Chicago.
                      controlUI.addEventListener('click', function() {
                            loadRoute();
                            //$(controlUI).hide();
                      });

                    }

                  function rad(x) {return x*Math.PI/180;}

                  function find_closest_marker( pos ) {
                    var lat = pos.lat;
                    var lng = pos.lng;
                    var R = 6371; // radius of earth in km
                    var distances = [];
                    var closest = -1;
                    var init = 0;
                    var end = elevations.length;
                    for( var i = 0; i < elevations.length; i++ ) {
                            var mlat = elevations[i].location.lat();
                            var mlng = elevations[i].location.lng();
                            var dLat  = rad(mlat - lat);
                            var dLong = rad(mlng - lng);
                            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                Math.cos(rad(lat)) * Math.cos(rad(lat)) * Math.sin(dLong/2) * Math.sin(dLong/2);
                            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            var d = R * c;
                            distances[i] = d;
                            if ( closest == -1 || d < distances[closest] ) {
                                closest = i;
                            }
                    }

                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Ejemplo');
                    data.addColumn('number', 'Altura');
                    data.addColumn({type: 'string', role: 'style'});

                    if (ida){
                        for (var i = 0; i < elevations.length; i++) {
                            if (i<closest)
                                data.addRow(['', elevations[i].elevation, 'color: #00ff00']);
                            else
                                data.addRow(['', elevations[i].elevation, 'color: #ff0000']);
                        }
                    } else {
                        for (var i = 0; i < elevations.length; i++) {
                            if (i>=closest)
                                data.addRow(['', elevations[i].elevation, 'color: #00ff00']);
                            else
                                data.addRow(['', elevations[i].elevation, 'color: #ff0000']);
                        }
                    }

                    document.getElementById('chart_div').style.display = 'block';
                    chart.draw(data, {
                      height: '100%',
                      legend: 'none',
                      titleY: 'Altura en metros',
                      focusBorderColor: '#00ff00'
                    });

                    chart.setSelection([]);
                    chart.setSelection([{column:1,row:closest+1}]);
                    console.log(closest);
                  }

                  // Takes an array of ElevationResult objects, draws the path on the map
                  // and plots the elevation profile on a GViz ColumnChart
                  function plotElevation(results) {
                    elevations = results;

                    var path = [];
                    for (var i = 0; i < results.length; i++) {
                      path.push(elevations[i].location);
                    }

                    if (polyline) {
                      polyline.setMap(null);
                    }

                    polyline = new google.maps.Polyline({
                      path: path,
                      strokeColor: "#FF0000",
                      map: map});

                    if (navigator.geolocation) {
                        var options = {
                              enableHighAccuracy: false,
                              timeout: 5000,
                              maximumAge: 0
                        };
                        navigator.geolocation.watchPosition(updatePosition, failureGetPosition, options);
                      } else {
                        // Browser doesn't support Geolocation
                        var infoWindow = new google.maps.InfoWindow({map: map});
                        handleLocationError(false, infoWindow, map.getCenter());
                    }
                  }

                  // Remove the green rollover marker when the mouse leaves the chart
                  function clearMouseMarker() {
                    if (mousemarker != null) {
                      mousemarker.setMap(null);
                      mousemarker = null;
                    }
                  }

                 /* // Geocode an address and add a marker for the result
                  function addAddress() {
                    //var address = document.getElementById('address').value;
                    geocoderService.geocode({ 'address': address }, function(results, status) {
                      //document.getElementById('address').value = "";
                      if (status == google.maps.GeocoderStatus.OK) {
                        var latlng = results[0].geometry.location;
                        addMarker(latlng, true);
                        if (markers.length > 1) {
                          var bounds = new google.maps.LatLngBounds();
                          for (var i in markers) {
                            bounds.extend(markers[i].getPosition());
                          }
                          map.fitBounds(bounds);
                        } else {
                          map.fitBounds(results[0].geometry.viewport);
                        }
                      } else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
                        alert("Address not found");
                      } else {
                        alert("Address lookup failed");
                      }
                    })
                  }*/

                  // Add a marker and trigger recalculation of the path and elevation
                  function addMarker(latlng, doQuery) {

                      var marker = new google.maps.Marker({
                        position: latlng,
                        icon: "no",
                        map: map,
                      })

                      google.maps.event.addListener(marker, 'dragend', function(e) {
                        updateElevation();
                      });

                      markers.push(marker);

                      if (doQuery) {
                        updateElevation();
                      }

                  }

                  // Trigger the elevation query for point to point
                  // or submit a directions request for the path between points
                  function updateElevation() {
                    if (markers.length > 1) {
                      var travelMode = 'walking';
                      if (travelMode != 'direct') {
                        calcRoute(travelMode);
                      } else {
                        var latlngs = [];
                        for (var i in markers) {
                          latlngs.push(markers[i].getPosition())
                        }
                        elevationService.getElevationAlongPath({
                          path: latlngs,
                          samples: SAMPLES
                        }, plotElevation);
                      }
                    }
                  }

                  // Submit a directions request for the path between points and an
                  // elevation request for the path once returned
                  function calcRoute(travelMode) {
                    var origin = markers[0].getPosition();
                    var destination = markers[markers.length - 1].getPosition();

                    var waypoints = [];
                    for (var i = 1; i < markers.length - 1; i++) {
                      waypoints.push({
                        location: markers[i].getPosition(),
                        stopover: true
                      });
                    }

                    var request = {
                      origin: origin,
                      destination: destination,
                      waypoints: waypoints
                    };

                    switch (travelMode) {
                      case "bicycling":
                        request.travelMode = google.maps.DirectionsTravelMode.BICYCLING;
                        break;
                      case "driving":
                        request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
                        break;
                      case "walking":
                        request.travelMode = google.maps.DirectionsTravelMode.WALKING;
                        break;
                    }

                    directionsService.route(request, function(response, status) {
                      if (status == google.maps.DirectionsStatus.OK) {
                        elevationService.getElevationAlongPath({
                          path: response.routes[0].overview_path,
                          samples: SAMPLES
                        }, plotElevation);
                      } else if (status == google.maps.DirectionsStatus.ZERO_RESULTS) {
                        alert("No se encuentra ruta entre estos dos puntos");
                      } else {
                        alert("Fallo de direcciones");
                      }
                    });
                  }

                  // Trigger a geocode request when the Return key is
                  // pressed in the address field
                  function addressKeyHandler(e) {
                 /*   var keycode;
                    if (window.event) {
                      keycode = window.event.keyCode;
                    } else if (e) {
                      keycode = e.which;
                    } else {
                      return true;
                    }

                    if (keycode == 13) {
                       addAddress();
                       return false;
                    } else {
                       return true;
                    }*/
                  }

                  function loadRoute() {
                    reset();
                    map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                    var bounds = new google.maps.LatLngBounds();
                    for (var i = 0; i < route.length; i++) {
                      var latlng = new google.maps.LatLng(
                        route[i].getPosition().lat(),
                        route[i].getPosition().lng()
                      );
                      addMarker(latlng, false);
                      bounds.extend(latlng);
                    }
                    updateElevation();
                  }

                  function cleanupRoutes(){
                    for (var i in route) {
                      route[i].setMap(null);
                    }
                    route = [];
                  }

                  function clearMarkers() {
                    for (var i in markers) {
                      markers[i].setMap(null);
                    }
                  }
                  // Clear all overlays, reset the array of points, and hide the chart
                  function reset() {
                    if (polyline) {
                      polyline.setMap(null);
                    }

                    for (var i in markers) {
                      markers[i].setMap(null);
                    }

                    markers = [];

                    document.getElementById('chart_div').style.display = 'none';
                  var locations = [
                    ["Partida",
                    "Partida",
                    "-38.005022",
                    "-57.542555",
                    "img/largada.png"
                    ]
                    ];

                gmarkers = [];

                function createMarker(latlng, html, icon) {
                    var marker = new google.maps.Marker({
                        position: latlng,
                        icon: icon,
                        map: map
                    });

                    google.maps.event.addListener(marker, 'click', function() {
                        infowindow.setContent(html);
                        infowindow.open(map, marker);
                    });
                    return marker;
                }

                for (var i = 0; i < locations.length; i++) {
                    gmarkers[locations[i][0]] =
                    createMarker(new google.maps.LatLng(locations[i][2], locations[i][3]), "<table style='width:100%;'><tr><td>" + locations[i][0] + "</td></tr></table>", locations[i][4]);
                }

                // Limitar rango de zoom
                google.maps.event.addListener(map, 'zoom_changed', function()
                {
                    if (map.getZoom() < 12){
                       map.setZoom(12);
                    }
                        if (map.getZoom() > 16){
                       map.setZoom(16);
                    }
                });
                }

                function myclick(i) {
                    google.maps.event.trigger(gmarkers[i],'click');
                }

                function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                  infoWindow.setPosition(pos);
                  infoWindow.setContent(browserHasGeolocation ?
                                        'Error: The Geolocation service failed.' :
                                        'Error: Your browser doesn\'t support geolocation.');
                }
    </script>
</head>
<body>
<div id="map"></div>
<div id="chart_div"></div>
</body>
</html>